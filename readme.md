# kvstore 更新日志与使用文档

## 版本更新记录

### kvstore_v_1
**发布时间**: 2025.10.10  
**更新内容**:  
- 加入了 `hash` 和 `红黑树` 两种数据引擎。  
- 客户端提供了各种测试样例代码。

**使用方法**:  
- **服务端**：  
  1. 执行 `make` 后，执行 `./kvstore "此处输入端口号参数"` 启动服务端。  
- **客户端**：  
  1. 客户端在 `client` 文件夹下执行 `make`，然后运行 `./client_test "server端IP" "server端端口号" "0-4"`。  
     参数 0-4 分别表示使用以下引擎并循环输入指定数量的命令：  
     - 0：红黑树引擎，1万条命令  
     - 1：红黑树引擎，3万条命令  
     - 2：数组引擎，1万条命令  
     - 3：hash引擎，1万条命令  

### kvstore_v_2
**发布时间**: 2025.10.13  
**更新内容**:  
- **持久化功能**：  
  1. 客户端输入 `SAVE` 命令，服务端可以将数据存储到服务器本地文件中。  
  2. 客户端输入 `LOAD` 命令，服务端可以从本地文件加载数据。  
  3. 服务端在遇到 `ctrl+c` 命令或被 `kill` 时，自动执行 `SAVE` 命令。  
  4. 服务器在启动时会自动加载指定文件夹中的数据。

**使用方法**:  
- 在 v1 的基础上，客户端可以输入 `SAVE` 和 `LOAD` 命令来手动保存和加载数据。  
- 服务器在异常情况时会自动保护数据，并且在启动时会加载数据。

### kvstore_v_3
**发布时间**: 2025.10.15  
**更新内容**:  
- **内存池**：  
  1. 引入一个内存池来替代系统 `malloc`，内存池提供大内存和小内存的分配方法，其中的空间可以重复使用。  
  2. 设置一个阈值，超过该阈值时会使用大内存分配方法，未超过时使用小内存分配方法。

### kvstore_v_4
**发布时间**: 2025.10.16  
**更新内容**:  
- **一次性发送并执行多条指令**：  
  1. 用户在需要发送多条指令时，在第一行写入 `#MULTI_COMMAND`，然后一行一条命令，最后再写入 `#FINISH`。  
  2. 服务器接收到 `#MULTI_COMMAND` 时，会进入多条指令执行模式，直到遇到 `#FINISH` 才结束。

**使用方法**:  
- 客户端与服务器连接后，输入 `#MULTI_COMMAND`，每行一条命令，最后输入 `#FINISH`，即可实现一次性发送并执行多条指令。

### kvstore_v_5
**发布时间**: 2025.10.16  
**更新内容**:  
- **主从同步功能**：  
  1. 构建一个主服务器与多个从服务器共同工作，当主服务器执行写、删、修改命令时，从服务器会同步执行相同操作，以保持数据一致性。

**使用方法**:  
- 主从服务器的代码相同，根据启动参数区分主从服务器。  
  - 主服务器命令：`./out/kvstore "端口号(从服务器通信端口 + 1000)"`  
  - 从服务器命令：`./out/kvstore "与客户端通信的端口" "主服务器IP" "主服务器端口(实际会连接主服务器端口 + 1000)"`  
- 客户端向主服务器发送 `SET` 命令后，可以在从服务器上通过 `GET` 命令获取相同数据。

## 性能测试报告

### 内存测试

#### 一、自定义内存池：
- **总操作数**: 120,000  
- **总数据量**: 207.11 MB  
- **总耗时**: 81.639 秒  
- **操作频率**: 1469.88 ops/sec  
- **吞吐量**: 2.54 MB/s  
- **平均每次操作耗时**: 680.329 微秒

**详细内存统计**:
- **总池大小**: 64.00 MB  
- **总使用量**: 26.32 MB (41.13%)
- **小块内存统计** (<= 4 KB):  
  - 当前块数: 50,003  
  - 当前使用: 24.74 MB (38.65%)  
  - 峰值使用: 24.74 MB  
- **大块内存统计** (> 4 KB):  
  - 当前块数: 10,002  
  - 当前使用: 7906.25 MB (12353.52%)  
  - 峰值使用: 7906.25 MB  

**分配统计**:
- **总分配次数**: 60,005  
- **空闲块数**: 3  
- **小块分配次数**: 80,003  
- **大块分配次数**: 20,004

#### 二、系统 malloc：

**混合内存测试性能报告**:
- **总操作数**: 120,000  
- **总数据量**: 207.11 MB  
- **总耗时**: 7.450 秒  
- **操作频率**: 16107.28 ops/sec  
- **吞吐量**: 27.80 MB/s  
- **平均每次操作耗时**: 62.084 微秒

**详细内存统计**:
- **当前占用**: 7930.99 MB  
- **峰值占用**: 7930.99 MB  
- **分配次数**: 90,005  
- **释放次数**: 30,000

#### 三、jemalloc：

**混合内存测试性能报告**:
- **总操作数**: 120,000  
- **总数据量**: 207.11 MB  
- **总耗时**: 10.923 秒  
- **操作频率**: 10,985.60 ops/sec  
- **吞吐量**: 18.96 MB/s  
- **平均每次操作耗时**: 91.028 微秒

**详细内存统计（jemalloc）**:
- **当前占用**: 7930.99 MB  
- **峰值占用**: 7930.99 MB  
- **分配次数**: 90,005  
- **释放次数**: 30,000

---

### 数据引擎性能测试（传 50w 条命令）

| 引擎类型   | 小数据量（秒） | 大数据量（秒） |
|------------|----------------|----------------|
| 数组       | 70.2           | 305.6          |
| 红黑树     | 130.6          | 220.4          |
| hash       | 135.7          | 185.7          |
